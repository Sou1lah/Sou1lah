name: Fix 3D Graphs

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout with force to get latest
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          
      # 2. Remove old 3D directory if exists
      - name: Clean old 3D files
        run: |
          rm -rf profile-3d-contrib
          
      # 3. Generate fresh 3D graphs
      - name: Generate 3D contribution graph
        uses: yoshi389111/github-profile-3d-contrib@0.7.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USERNAME: Sou1lah
          
      # 4. Verify files were created
      - name: Check generated files
        run: |
          echo "Files generated:"
          ls -la profile-3d-contrib/
          echo "File sizes:"
          du -sh profile-3d-contrib/*
          
      # 5. Use GitHub CLI to commit and push (more reliable)
      - name: Commit and push with GitHub CLI
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add only 3D files
          git add profile-3d-contrib/
          
          # Check for changes
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Create commit
          git commit -m "Add 3D contribution graphs"
          
          # Force push just the 3D directory
          git push origin HEAD:main --force-with-lease
